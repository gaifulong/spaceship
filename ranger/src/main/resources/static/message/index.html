<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        html {
            width: 100%;
            height: 100%;
        }
        body {
            width: 100%;
            height: 100%;
        }
        .container {
            height: 100%;
        }
        .main {
            height: 100%;
            display: flex;
            display: -webkit-flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .main-header {

        }
        .main-content {
            flex-grow: 1;
            overflow:auto;
        }
        .main-footer {

        }
    </style>
</head>
<body>
<!--    <label for="url"></label>-->
<!--    <input id="url" type="text" size="60" value="ws://localhost:8080/web_socket/message/m666666"/>-->
    <div class="container">
        <div class="main">
            <div class="main-header">
                <button onclick="openWebSocket()">打开WebSocket连接</button>
                <button onclick="closeWebSocket()">关闭WebSocket连接</button>
            </div>
            <div class="main-content">
                <div id="message"></div>
            </div>
            <div class="main-footer">
                <input id="inputText" type="text"/>
                <button onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var websocket = null;
        function openWebSocket () {
            if (websocket != null) {
                return;
            }
            // var url = document.getElementById("url").value.trim();
            var tempUserId = randomString();
            var host = window.location.host
            var url = "ws://"+host+"/web_socket/message/" + tempUserId
            // 判断当前浏览器是否支持 WebSocket
            if ('WebSocket' in window) {
                websocket = new WebSocket(url);
            } else {
                alert ('当前浏览器不支持 WebSocket')
            }
            // 连接发生错误的回调方法
            websocket.onerror = function () {
                setMessageInnerHTML ("WebSocket 连接发生错误");
                websocket = null;
            };
            // 连接成功建立的回调方法
            websocket.onopen = function () {
                setMessageInnerHTML ("WebSocket 连接成功");
            };
            // 收到消息的回调方法
            websocket.onmessage = function (event) {
                let message = JSON.parse(event.data)
                setMessageInnerHTML (message.content);
            };
            // 连接关闭的回调方法
            websocket.onclose = function () {
                setMessageInnerHTML ("WebSocket 连接关闭");
                websocket = null;
            };
        }

        /**
         * 监听窗口关闭事件
         * 当窗口关闭时，主动关闭websocket 连接
         * 防止连接还没断开就关闭窗口，server端会抛异常
         */
        window.onbeforeunload = function () {
            closeWebSocket ()
        }

        /**
         * 将消息显示在网页上
         */
        function setMessageInnerHTML (innerHTML) {
            document.getElementById("message").innerHTML += innerHTML + '<br/>';
        }

        /**
         * 关闭 WebSocket 连接
         */
        function closeWebSocket () {
            websocket.close();
        }

        /**
         * 生成指定长度随机字符串
         * @returns {string}
         */
        function randomString() {
            var length = 32;
            var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            var result = '';
            for (var i = length; i > 0; --i)
                result += chars[Math.floor(Math.random() * chars.length)];
            return result;
        }

        /**
         * 发送消息
         */
        function sendMessage () {
            let m = document.getElementById("inputText").value.trim();
            if (m == null || m.length === 0) return;
            let message = {
                from: '',
                to: '',
                content: m,
                state: 0
            }
            websocket.send(JSON.stringify(message));
            document.getElementById("inputText").value = ''
        }
    </script>
</body>
</html>